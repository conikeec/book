# Run

Now we will begin to code Rust in R.

## `rustinr` R package

`rustinr` is a R package to help user generate the basic struture of a Rust-R package and source Rust script in R. Install it with 

```r
devtools::install_github("rustr/rustinr")
```

### Rust Function in R Console

`rust()` is a R function to create Rust function in R console interatively.

If there is a Rust function:

```rust
// #[rustr_export]
pub fn say_hi() -> String{
	"Hello World".into()
}
```

Just mark it with `// #[rustr_export]`, and put this function in `rust()`

```{r}
library(rustinr)

rust(code = '
// #[rustr_export]
pub fn say_hi() -> String{
	"Hello World".into()
}
')
```

and then you can call `say_hi` in R.

```{r}
say_hi()

say_hi
``` 

Here is another example:

```{r}
rust(code = '
// #[rustr_export]
pub fn fib_rs(x:u64)-> u64{
    if x == 0 { return 0 };
    if x == 1 { return 1 };
    return fib_rs(x - 1) + fib_rs(x - 2);
}')

fib_rs(10L)
```

For more example, you can also checkout https://gallery.rustr.org


## Create a Rust-R Package

### Init a Package

`rustr_init` will create an R package with Rust support.

Just run:

```{r}
rustr_init("pkgname",".")

list.dirs("pkgname")
```

```{r,include=FALSE}
try(system("rm -rf ./pkgname"))
```

`pkgname/src/rustlib` is a Rust library, for more info see http://doc.crates.io/

Rust files are in `pkgname/src/rustlib/src`.  

`pkgname/src/rustlib/src/lib.rs` should begin with:

```{r}
# Run This In R
headr()
```

or

```rust
#[macro_use]
extern crate rustr;
pub mod export;
pub use rustr::*;
```


### Intro `rustrize()`

Rust function begin with `// #[rustr_export]` will be imported to R by `rustrize()` R function.

```rust
// /src/rustlib/src/lib.rs

#[macro_use]
extern crate rustr;
pub mod export;
pub use rustr::*;

// ' Roxygen Comment Header (Optional)
// ' 
// ' detail info about function
// ' @param a parameter detail
// ' @export
// #[rustr_export]
pub fn say_hi()-> String{
	"Hello World!".into()
}
```

and then run `rustrize()`.

#### Generated Files

These files are generated by `rustrize()`.

1. `/R/REXPORT.R` - `.Call()` binding in R.
1. `/src/REXPORT.c` - Exported `.Call()` Functions.
1. `/src/rustlib/src/export.rs` - A public module in /src/rustlib/src/lib.rs, this module export Rust function to R.

```r
# /R/REXPORT.R

#' Roxygen Comment Header (Optional)
#' 
#' detail info about function
#' @param a parameter detail
#' @export
say_hi = function(){ .Call('SvhCRFYxjsuH_say_hi',PACKAGE = 'SvhCRFYxjsuH')}
```

```c
// /src/REXPORT.c

#include <Rinternals.h>
#include <R.h>

extern SEXP rustr_say_hi();
SEXP SvhCRFYxjsuH_say_hi(){ return(rustr_say_hi());}

```

```rust
// /src/rustlib/src/export.rs

use super::*;

#[no_mangle]
pub extern "C" fn rustr_say_hi()->SEXP{

 let res  = say_hi();

 let res_sexp : SEXP = unwrapr!(res.intor());

 return res_sexp;
}

```

And your R package are ready to `R CMD build`.

## Summary

### rust()

```r
rust(path = "Rust file", code = "Rust code", depend = "Optional Cargo TOML dependency")
``` 

Source Rust file or code in R console.

### rustr_init()

```r
rustr_init(name = "R package name", path = "Pacakage path")
```

Init a Rust-R package struture. It is similar to `package.skeleton()`.

### headr()

```r
headr()
```

Give you the header of the `lib.rs` for Rust Library to get started with R.

### rustrize()

```r
rustrize(path = ".")
```

Generate R function for Rust function in a R package. It is similar to `compileAttributes()` in `Rcpp`.

